<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Перенаправление во внешний браузер</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        window.addEventListener('load', function() {
            // Проверяем, уже перенаправили ли (параметр ext=1)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('ext')) {
                // Уже во внешнем — показываем основной контент
                showMainContent();
                return;
            }

            // Надёжная проверка на Telegram in-app
            const isTelegramInApp = 
                (window.Telegram && window.Telegram.WebApp) ||
                (typeof window.TelegramWebview !== 'undefined') ||
                /telegram/i.test(navigator.userAgent);

            if (!isTelegramInApp) {
                showMainContent();
                return;
            }

            // Текущий URL + параметр для предотвращения loop
            let baseUrl = window.location.href;
            if (!baseUrl.includes('?')) {
                baseUrl += '?ext=1';
            } else {
                baseUrl += '&ext=1';
            }

            let redirected = false;

            // 1. Официальный метод (хорошо работает на iOS, иногда на Android)
            if (window.Telegram && window.Telegram.WebApp && typeof Telegram.WebApp.openLink === 'function') {
                Telegram.WebApp.openLink(baseUrl);
                redirected = true;
            }

            // 2. Intent-хак для Android (самый надёжный)
            const ua = navigator.userAgent.toLowerCase();
            const isAndroid = ua.includes('android');

            if (isAndroid) {
                const hostPath = baseUrl.replace(/^https?:\/\//, '');
                const intentUrl = `intent://${hostPath}#Intent;scheme=https;end`;
                window.location.href = intentUrl;
                redirected = true;
            }

            // Fallback: если через 2 сек не ушло — кнопка
            setTimeout(function() {
                if (!redirected || document.visibilityState === 'visible') {
                    showManualButton(baseUrl);
                }
            }, 2000);
        });

        function showManualButton(url) {
            document.body.innerHTML = `
                <div style="
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    text-align: center;
                    padding: 40px 20px;
                    background: #f0f0f0;
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                ">
                    <h2>Откройте во внешнем браузере</h2>
                    <p>Автоматическое перенаправление не сработало.<br>Нажмите кнопку ниже.</p>
                    <a href="${url}" target="_blank" rel="noopener" style="
                        display: inline-block;
                        background: #0088cc;
                        color: white;
                        padding: 16px 32px;
                        font-size: 18px;
                        border-radius: 12px;
                        text-decoration: none;
                        margin-top: 20px;
                    ">Открыть во внешнем браузере</a>
                </div>
            `;
        }

        function showMainContent() {
            // Здесь твой основной контент сайта
            document.body.innerHTML = `
                <div style="text-align:center; padding:50px; font-family:sans-serif;">
                    <h1>Добро пожаловать!</h1>
                    <p>Это ваш сайт в полноценном внешнем браузере.</p>
                    <!-- Добавь сюда свой реальный контент -->
                </div>
            `;
        }
    </script>
</head>
<body style="margin:0; background:#fff;">
    <div style="text-align:center; padding:50px; font-family:sans-serif; color:#666;">
        <p>Перенаправляем во внешний браузер...</p>
        <p>Подождите пару секунд.</p>
    </div>
</body>
</html>
